name: Docker Multi-Arch (Optimized)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '00 02 * * *'

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  PLATFORMS: "linux/arm64,linux/amd64"
  MAX_RETRIES: 3
  RETRY_DELAY: 10

jobs:
  build:
    name: Pull and Push Multi-Arch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:latest

      - name: Login to Registry
        env:
          REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
        run: |
          echo "$REGISTRY_PASSWORD" | docker login -u "${{ secrets.ALIYUN_REGISTRY_USER }}" --password-stdin "${{ secrets.ALIYUN_REGISTRY }}"

      - name: Login to Registry
        run: |
          echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | \
          docker login -u "${{ secrets.ALIYUN_REGISTRY_USER }}" \
          --password-stdin "${{ secrets.ALIYUN_REGISTRY }}"

      - name: Process Images
        run: |
          set -euo pipefail
          
          images_file="images.txt"
          if [[ ! -f "$images_file" ]]; then
            echo "âŒ é”™è¯¯: $images_file æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [[ ! -s "$images_file" ]]; then
            echo "âš ï¸  è­¦å‘Š: $images_file æ–‡ä»¶ä¸ºç©º"
            exit 0
          fi
          
          echo "âœ… å¼€å§‹å¤„ç†..."
          
          parse_image() {
            local line="$1"
            echo "$line" | awk '{print $NF}' | sed 's/@sha256.*//'
          }
          
          detect_duplicate_images() {
            local -A image_names
            local duplicates=()
            while IFS= read -r line || [[ -n "$line" ]]; do
              [[ -z "$line" || "$line" =~ ^\s*# ]] && continue
              image=$(parse_image "$line")
              image_name=$(echo "$image" | awk -F'/' '{print $NF}' | awk -F':' '{print $1}')
              if [[ -n "${image_names[$image_name]}" ]]; then
                local already_added=false
                for dup in "${duplicates[@]:-}"; do
                  if [[ "$dup" == "$image_name" ]]; then
                    already_added=true
                    break
                  fi
                done
                [[ "$already_added" == "false" ]] && duplicates+=("$image_name")
              fi
              image_names[$image_name]=1
            done
            printf '%s\n' "${duplicates[@]}" 2>/dev/null || true
          }
          
          duplicate_images=$(detect_duplicate_images | sort -u)
          
          total=0 success=0 skip=0 error=0
          
          while IFS= read -r line || [[ -n "$line" ]]; do
            [[ -z "$line" || "$line" =~ ^\s*# ]] && continue
            
            ((total++))
            image=$(parse_image "$line")
            image_name=$(echo "$image" | awk -F'/' '{print $NF}' | awk -F':' '{print $1}')
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1}')
            
            prefix=""
            for dup in $duplicate_images; do
              if [[ "$image_name" == "$dup" ]] && [[ -n "$name_space" ]]; then
                prefix="${name_space}_"
                break
              fi
            done
            
            new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/${prefix}${image##*/}"
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ å¤„ç†é•œåƒ [$total]: $image"
            echo "   ç›®æ ‡: $new_image"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            echo "ğŸ” æ£€æŸ¥æºé•œåƒæ”¯æŒçš„æ¶æ„..."
            supported_archs=$(docker buildx imagetools inspect "$image" --format='{{range .Manifest.Manifests}}{{.Platform.OS}}/{{.Platform.Architecture}}{{if .Platform.Variant}}/{{.Platform.Variant}}{{end}} {{end}}' 2>/dev/null || echo "")
            
            if [[ -z "$supported_archs" ]]; then
              supported_archs=$(docker buildx imagetools inspect "$image" --format='{{.Platform.OS}}/{{.Platform.Architecture}}{{if .Platform.Variant}}/{{.Platform.Variant}}{{end}}' 2>/dev/null || echo "")
            fi
            
            echo "   æ”¯æŒçš„æ¶æ„: ${supported_archs:-æ— æ³•è·å–}"
            
            build_platforms=""
            for platform in $(echo "$PLATFORMS" | tr ',' ' '); do
              arch=$(echo "$platform" | awk -F'/' '{print $2}')
              if [[ "$supported_archs" == *"$arch"* ]] || [[ -z "$supported_archs" ]]; then
                if [[ -z "$build_platforms" ]]; then
                  build_platforms="$platform"
                else
                  build_platforms="$build_platforms,$platform"
                fi
              else
                echo "   â­ï¸  è·³è¿‡ä¸æ”¯æŒçš„æ¶æ„: $platform"
              fi
            done
            
            if [[ -z "$build_platforms" ]]; then
              echo "âŒ æ²¡æœ‰å¯æ„å»ºçš„å¹³å°ï¼Œè·³è¿‡æ­¤é•œåƒ"
              ((skip++))
              continue
            fi
            
            echo "ğŸ”¨ å‡†å¤‡æ„å»ºå¹³å°: $build_platforms"
            
            tmp_dir=$(mktemp -d)
            trap 'rm -rf "$tmp_dir"' EXIT
            echo "FROM $image" > "$tmp_dir/Dockerfile"
            
            echo "ğŸš€ å¼€å§‹æ„å»ºå’Œæ¨é€..."
            if docker buildx build \
              --platform "$build_platforms" \
              --pull \
              --tag "$new_image" \
              --push \
              --file "$tmp_dir/Dockerfile" \
              --cache-from "type=registry,ref=$new_image" \
              --cache-to type=inline \
              --provenance=false \
              --sbom=false \
              "$tmp_dir" 2>&1; then
              echo "âœ… æˆåŠŸæ„å»ºå¹¶æ¨é€: $new_image"
              ((success++))
            else
              echo "âš ï¸  å¤šæ¶æ„æ„å»ºå¤±è´¥ï¼Œå°è¯•å•æ¶æ„é™çº§æ„å»º..."
              fallback_success=false
              for platform in $(echo "$build_platforms" | tr ',' ' '); do
                platform_suffix="${platform//\//_}"
                platform_tag="$new_image-$platform_suffix"
                echo "   å°è¯•å•ç‹¬æ„å»º: $platform"
                if docker buildx build \
                  --platform "$platform" \
                  --pull \
                  --tag "$platform_tag" \
                  --push \
                  --file "$tmp_dir/Dockerfile" \
                  --provenance=false \
                  --sbom=false \
                  "$tmp_dir" 2>&1; then
                  echo "   âœ… å•æ¶æ„æ„å»ºæˆåŠŸ: $platform"
                  fallback_success=true
                else
                  echo "   âŒ å•æ¶æ„æ„å»ºå¤±è´¥: $platform"
                fi
              done
              if [[ "$fallback_success" == "true" ]]; then
                echo "âš ï¸  éƒ¨åˆ†æ¶æ„æ„å»ºæˆåŠŸï¼ˆé™çº§æ¨¡å¼ï¼‰"
                ((success++))
              else
                ((error++))
              fi
            fi
            
            if (( total % 5 == 0 )); then
              docker builder prune -f --filter until=1h || true
            fi
          done < "$images_file"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§¹ æ‰§è¡Œæœ€ç»ˆæ¸…ç†..."
          docker system prune -af --volumes || true
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   æ€»é•œåƒæ•°: $total"
          echo "   âœ… æˆåŠŸ: $success"
          echo "   âŒ å¤±è´¥: $error"
          echo "   â­ï¸  è·³è¿‡: $skip"
          
          if (( total > 0 )); then
            success_rate=$(( success * 100 / total ))
            echo "   æˆåŠŸç‡: ${success_rate}%"
          else
            echo "   æˆåŠŸç‡: N/A"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if (( error == 0 )); then
            echo "ğŸ‰ æ‰€æœ‰é•œåƒå¤„ç†æˆåŠŸï¼"
            exit 0
          elif (( success > 0 )); then
            echo "âš ï¸  éƒ¨åˆ†é•œåƒå¤„ç†æˆåŠŸï¼Œæœ‰ $error ä¸ªå¤±è´¥"
            exit 1
          else
            echo "ğŸ’¥ æ‰€æœ‰é•œåƒå¤„ç†å¤±è´¥"
            exit 2
          fi
